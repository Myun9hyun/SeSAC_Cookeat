<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="./static/nav.css" />
        <style>
            #cssmenu ul li ul {
                display: none;
            }
            #cssmenu ul li.active ul {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="nav-bg-container">
            <div class="content-nav">
                <nav id="primary_nav_wrap">
                    <ul>
                        <li>
                            <a href="/">
                                <img
                                    src="./static/spoon.png"
                                    alt="spoon"
                                    style="width: 40px; height: 40px"
                                />
                            </a>
                        </li>
                        <li>
                            <a href="/community">Community</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div id="cssmenu">
                <li id="userNavItem" style="display: none">
                    <span id="userText"></span>
                </li>
                <ul>
                    <li class="has-sub" id="profileBtn">
                        <img
                            src="./static/account.png"
                            alt="Profile"
                            style="width: 30px; height: 30px"
                            class="account-image"
                        />

                        <ul>
                            <li>
                                <a href="/login"><span>Login</span></a>
                            </li>
                            <li>
                                <a href="/Join"><span>Join</span></a>
                            </li>
                            <li>
                                <a href="/profile"><span id="userText">Mypage</span></a>
                            </li>
                            <li>
                                <a href="#" id="logoutBtn"><span>Logout</span></a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var profileBtn = document.getElementById("profileBtn");
                var logoutBtn = document.getElementById("logoutBtn");
                var userNavItem = document.getElementById("userNavItem");

                profileBtn.addEventListener("click", function () {
                    profileBtn.classList.toggle("active");
                });

                function updateNavbarWithUserData() {
                    // 로컬 스토리지에서 쿠키를 가져옴
                    var token = localStorage.getItem("user");

                    // 토큰 디코딩
                    if (token) {
                        try {
                            // Base64 디코딩
                            var base64Decoded = atob(token.split(".")[1]);

                            // UTF-8 디코딩
                            var decodedToken = JSON.parse(
                                new TextDecoder().decode(
                                    new Uint8Array([...base64Decoded].map((c) => c.charCodeAt(0)))
                                )
                            );

                            // 디코딩된 토큰을 콘솔에 출력
                            console.log("Decoded token:", decodedToken);

                            // 사용자 정보를 네비게이션 바에 표시
                            if (decodedToken && decodedToken.username) {
                                userNavItem.style.display = "block";
                                userNavItem.textContent = "Welcome, " + decodedToken.username;
                            }
                        } catch (error) {
                            console.error("Error decoding token:", error);
                        }
                    }
                }

                logoutBtn.addEventListener("click", function (event) {
                    // 이 부분에서 로컬 스토리지에서 쿠키를 삭제하고, 알림을 표시하고 index 페이지로 이동하는 코드를 추가하세요.
                    localStorage.removeItem("user");
                    alert("로그아웃 완료!");
                    window.location.href = "/"; // 홈페이지로 이동
                });

                // 페이지 로드 시 사용자 정보 업데이트
                updateNavbarWithUserData();
            });
        </script>
    </body>
</html>
