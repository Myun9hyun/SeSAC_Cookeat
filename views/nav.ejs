<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="./static/nav.css" />
        <style>
            #cssmenu ul li ul {
                display: none;
            }
            #cssmenu ul li.active ul {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="nav-bg-container">
            <div class="content-nav">
                <nav id="primary_nav_wrap">
                    <ul>
                        <li>
                            <a href="/">
                                <img
                                    src="./static/spoon.png"
                                    alt="spoon"
                                    style="width: 40px; height: 40px"
                                />
                            </a>
                        </li>
                        <li>
                            <a href="/community">Community</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div id="cssmenu">
                <li id="userNavItem" style="display: none">
                    <span id="userText"></span>
                </li>
                <ul>
                    <li class="has-sub" id="profileBtn">
                        <img
                            src="./static/account.png"
                            alt="Profile"
                            style="width: 30px; height: 30px"
                            class="account-image"
                        />
                        <ul>
                            <li>
                                <a href="/login"><span>Login</span></a>
                            </li>
                            <li>
                                <a href="/Join"><span>Join</span></a>
                            </li>
                            <li id="profileLink">
                                <a href="/profile"><span id="userText">Mypage</span></a>
                            </li>
                            <li>
                                <a href="/" id="logoutBtn"><span>Logout</span></a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var profileBtn = document.getElementById("profileBtn");
                var logoutBtn = document.getElementById("logoutBtn");
                var userNavItem = document.getElementById("userNavItem");
                var profileLink = document.getElementById("profileLink");

                profileBtn.addEventListener("click", function () {
                    profileBtn.classList.toggle("active");
                });

                function updateNavbarWithUserData() {
                    var token = localStorage.getItem("user");

                    if (token) {
                        try {
                            var base64Decoded = atob(token.split(".")[1]);
                            var decodedToken = JSON.parse(
                                new TextDecoder().decode(
                                    new Uint8Array([...base64Decoded].map((c) => c.charCodeAt(0)))
                                )
                            );

                            if (decodedToken && decodedToken.userId) {
                                userNavItem.style.display = "block";
                                userNavItem.textContent = "Welcome, " + decodedToken.userId;
                                profileLink.style.display = "block";
                            }
                        } catch (error) {
                            console.error("Error decoding token:", error);
                        }
                    }
                }

                logoutBtn.addEventListener("click", function (event) {
                    var token = localStorage.getItem("user");

                    if (!token) {
                        // 토큰이 없으면 로그인 페이지로 이동
                        alert("로그인이 필요합니다!");
                        window.location.href = "/login";
                    } else {
                        // 토큰이 있으면 로그아웃 수행
                        localStorage.removeItem("user");
                        alert("로그아웃 완료!");
                        window.location.href = "/";
                    }

                    // localStorage.removeItem("user");
                    // alert("로그아웃 완료!");
                    // window.location.href = "/";
                });

                updateNavbarWithUserData();
            });
        </script>
    </body>
</html>
